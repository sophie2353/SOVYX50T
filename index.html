<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOVYX Web</title>
  <style>
    body { font-family: 'Segoe UI', Arial; background:#1a1a1a; color:#fff; padding:20px; }
    section { margin-bottom:30px; padding:20px; background:rgba(255,255,255,0.05); border-radius:12px; }
    h1,h2 { color:#3eb489; }
    button,input,textarea { margin-top:10px; padding:10px; border-radius:6px; }
    img.preview { max-width:200px; margin-top:10px; border-radius:8px; }
  </style>
</head>
<body>

<!-- Iniciar sesi贸n -->
<section id="login">
  <h1>Iniciar sesi贸n con Instagram</h1>
  <p>Conecta tu cuenta para publicar y activar segmentaci贸n.</p>
  <button onclick="loginInstagram()">Conectar Instagram</button>
  <div id="loginResult"></div>
</section>

<!-- Publicar -->
<section id="publicar">
  <h2>Publicar en Instagram + Segmentaci贸n</h2>
  <label>Caption:</label><br>
  <textarea id="caption">Hola desde SOVYX </textarea><br>
  <label>Seleccionar Imagen:</label><br>
  <input type="file" id="imageInput" accept="image/*"><br>
  <div id="preview"></div>
  <button onclick="publishFlow()">Publicar y activar alcance</button>
  <div id="publishResult"></div>
</section>

<!-- Estad铆sticas -->
<section id="estadisticas">
  <h2>Estad铆sticas</h2>
  <button onclick="getInsights()">Ver Insights</button>
  <div id="insightsResult"></div>
</section>

<script>
const BASE_URL = "https://sovyxbackend-production.up.railway.app/api";

// Vista previa de imagen
const input = document.getElementById("imageInput");
const preview = document.getElementById("preview");
input.addEventListener("change", () => {
  preview.innerHTML = "";
  const file = input.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.createElement("img");
      img.src = e.target.result;
      img.className = "preview";
      preview.appendChild(img);
    };
    reader.readAsDataURL(file);
  }
});

// Login IG
function loginInstagram() {
  const clientId = "3413258278838360";
  const redirectUri = "https://sovyxbackend-production.up.railway.app/ig/callback";
  const scope = "instagram_business_basic,instagram_business_content_publish,instagram_business_manage_insights";
  const authUrl = `https://www.instagram.com/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}&response_type=code`;
  window.location.href = authUrl;
}

// Publicar + segmentaci贸n autom谩tica
async function publishFlow() {
  const caption = document.getElementById("caption").value;
  const file = document.getElementById("imageInput").files[0];
  if (!file) { alert("Selecciona una imagen"); return; }

  const formData = new FormData();
  formData.append("caption", caption);
  formData.append("image", file);

  // 1. Publicar
  const res = await fetch(`${BASE_URL}/instagram/publish`, { method:"POST", body:formData });
  const data = await res.json();
  document.getElementById("publishResult").innerHTML = `<p>Post publicado con ID: ${data.id}</p>`;

  // 2. Construir audiencia (100k LATAM+EUROPA, high ticket)
  const audRes = await fetch(`${BASE_URL}/audience/build`, {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ 
      session_id:"gh_session", 
      constraints:{ size:100000, geo:["LATAM","EUROPA"], segment:"high_ticket", platform:"instagram" } 
    })
  });
  const audData = await audRes.json();

  // 3. Asignar delivery (24h)
  const delRes = await fetch(`${BASE_URL}/delivery/assign`, {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ session_id:"gh_session", audience_id:audData.id, window_hours:24 })
  });
  const delData = await delRes.json();

  // 4. Mostrar resultados + cierre estimado (30%)
  const cierreEstimado = Math.floor(delData.reach * 0.30);
  document.getElementById("publishResult").innerHTML += `
    <p>Segmentaci贸n activa: ${delData.reach} personas en LATAM+EUROPA (24h)</p>
    <p>Cierre estimado: ${cierreEstimado} personas interesadas (30%)</p>
  `;
}

// Insights
async function getInsights() {
  const res = await fetch(`${BASE_URL}/instagram/insights/17895695668004550`);
  const data = await res.json();
  document.getElementById("insightsResult").innerHTML = `<p>Alcance real: ${data.reach} | Likes: ${data.likes}</p>`;
}
</script>

</body>
</html>
