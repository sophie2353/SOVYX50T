<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sovyx</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #4a4a4a; }
    .section { margin-bottom: 30px; }
    button { margin-top: 10px; padding: 10px 15px; cursor: pointer; }
    input, textarea, select { display: block; margin-top: 10px; width: 100%; max-width: 400px; }
  </style>
</head>
<body>

  <!-- Bienvenida -->
  <div class="section">
    <h1>Bienvenido a Sovyx 游깷</h1>
    <p>Sesi칩n iniciada con <strong>owner</strong> y clientes disponibles.</p>
    <label for="client">Selecciona cuenta:</label>
    <select id="client">
      <option value="">Owner (tu cuenta)</option>
      <option value="client1">Cliente 1</option>
      <option value="client2">Cliente 2</option>
      <option value="client3">Cliente 3</option>
    </select>
  </div>

  <!-- Conectar con backend y token -->
  <div class="section">
    <h2>Conectar con Backend</h2>
    <button onclick="refreshToken()">游댐 Refrescar Token</button>
  </div>

  <!-- Formulario con objetivo -->
  <div class="section">
    <h2>Objetivo de Ventas</h2>
    <label for="objetivo">Selecciona objetivo:</label>
    <select id="objetivo">
      <option value="5">5 ventas</option>
      <option value="10">10 ventas</option>
      <option value="100">100 ventas</option>
    </select>
  </div>

  <!-- Seleccionar post activo -->
  <div class="section">
    <h2>Seleccionar Post Activo</h2>
    <input type="text" id="postLink" placeholder="Pega aqu칤 el link del post de Instagram" />
  </div>

  <!-- Botones de acciones -->
  <div class="section">
    <button onclick="lanzarCampa침a()">Mejorar</button>
    <button onclick="verEstadisticas()">Ver estad칤sticas</button>
    <button onclick="analizarObjetivo()">An치lisis seg칰n objetivo</button>
  </div>

  <!-- Resultados -->
  <div class="section">
    <h2>Resultados</h2>
    <pre id="output"></pre>
  </div>

<script>
  const API_BASE = "https://sovyx-ia.vercel.app";

  function getClientPath(endpoint) {
    const client = document.getElementById("client").value;
    return client ? `/api/${client}/${endpoint}` : `/api/${endpoint}`;
  }

  async function refreshToken() {
    const client = document.getElementById("client").value;
    const path = client ? `/ig/${client}/refresh` : `/ig/refresh`;
    const res = await fetch(`${API_BASE}${path}`);
    const data = await res.json();
    document.getElementById("output").textContent = JSON.stringify(data, null, 2);
  }
  
  async function lanzarCampa침a() {
    const client = document.getElementById("client").value || "owner";
    const sessionId = Date.now().toString(); // ID 칰nico por campa침a
    const postLink = document.getElementById("postLink").value;

    if (!postLink) {
      alert("Debes pegar el link del post de Instagram");
      return;
    }

    try {
      // 1. Construir audiencia
      const audRes = await fetch(`${API_BASE}/api/${client}/audience/build`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId })
      });
      const audiencia = await audRes.json();

      // 2. Asignar delivery
      const delivRes = await fetch(`${API_BASE}/api/${client}/delivery/assign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: sessionId,
          audience_id: audiencia.audience_id,
          post: postLink,
          window_hours: 24
        })
      });
      const entrega = await delivRes.json();

      // Mostrar resultados en pantalla
      document.getElementById("output").textContent =
        JSON.stringify({ audiencia, entrega }, null, 2);

    } catch (err) {
      console.error("Error en lanzarCampa침a:", err);
      document.getElementById("output").textContent = "Error lanzando campa침a";
    }
  }

  async function verEstadisticas() {
    const client = document.getElementById("client").value || "owner";
    const mediaId = prompt("Ingresa el mediaId del post publicado:");
    if (!mediaId) return;

    const res = await fetch(`${API_BASE}/api/${client}/instagram/insights/${mediaId}`);
    const data = await res.json();
    document.getElementById("output").textContent = JSON.stringify(data, null, 2);
  }

  function analizarObjetivo() {
    const objetivo = document.getElementById("objetivo").value;
    let mensaje = "";

    if (objetivo === "5") mensaje = "Meta peque침a: enf칩cate en segmentaci칩n precisa y cierres r치pidos.";
    if (objetivo === "10") mensaje = "Meta intermedia: necesitas buen alcance y optimizar el delivery.";
    if (objetivo === "100") mensaje = "Meta grande: requiere m치xima segmentaci칩n, constancia y an치lisis de m칠tricas.";

    document.getElementById("output").textContent = mensaje;
  }
</script>

</body>
</html>
